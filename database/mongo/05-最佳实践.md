[TOC]

# 最佳实践

## 一. 关于连接到MongoDB

- 驱动程序: 总是选择与所有的MongoDB相兼容的驱动程序

- 连接对象MongoClient: 使用MongoClient对象连接到MongoDB实例时总是应该保证它单例,并且在整个生命周期中都从它获取其它操作对象

- 连接字符串: 连接字符串中可以配置大部份连接选项. 建议总是在连接字符串中配置这些选项.

  > - 连接到复制集: `mongodb://节点1,节点2...节点n/database?[]options`
  > - 连接到分片集: `mongodb://mongos1,mongos12...mongos1n/database?[options]`
  >
  > **`options`**:
  >
  > - `maxPoolSize`: 连接池大小
  > - `MaxWaitTime`: 最大等待时长,建议设置
  > - `WriteConcern`: 建议`majority`
  > - `ReadConcern`: 对数据一致性要求高的场景适当使用.
  >
  > 连接方式:
  >
  > - 使用域名连接集群: 使用mongodb+srv://域名
  > - 不要在mongos前面使用负载均衡
  > - 游标的使用,

## 二. 关于查询及索引

- 每一个查询都必须要有对应的索引
- 尽量使用覆盖索引(Covered Indexes)
- 使用`projection`来减少返回客户端的文档的内容

## 三. 关于写入

- 在`update`语句里只包括需要更新的字段
- 尽可能使用批量插入来提升写入性能
- 使用TTL自动过期日志类型的数据

## 四. 关于文档结构

- 防止使用太长的字段名
- 防止使用太深的数组嵌套(超过2层就比较复杂)
- 不使用中文,标点符号等非拉丁字母作为字段名

## 五. 处理分页问题: 避免使用count

## 六. 关于事务

使用事务的原则:

- 无论何时,事务的使用总是能避免则避免
- 模型设计先于事务,尽可能用模型设计来规避事务
- 不要使用过大的事务,尽量控制在1000个文档更新以内
- 当必须使用事务时,尽可能让涉及事务的文档分布在同一个分片上,这将有效的提高效率.







