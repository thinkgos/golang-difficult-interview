[TOC]

# 运算符

## 一. 查询和投影运算符

> [查询和投影运算符](https://docs.mongodb.com/manual/reference/operator/query/#query-selectors)

### 1. 比较查询运算符

| Name                                                         | Description              |
| :----------------------------------------------------------- | :----------------------- |
| [`$eq`](https://docs.mongodb.com/manual/reference/operator/query/eq/#op._S_eq) | 匹配等于指定值的值       |
| [`$ne`](https://docs.mongodb.com/manual/reference/operator/query/ne/#op._S_ne) | 匹配不等于指定值的值     |
| [`$gt`](https://docs.mongodb.com/manual/reference/operator/query/gt/#op._S_gt) | 匹配大于指定值的值       |
| [`$gte`](https://docs.mongodb.com/manual/reference/operator/query/gte/#op._S_gte) | 匹配大于等于指定值的值   |
| [`$lt`](https://docs.mongodb.com/manual/reference/operator/query/lt/#op._S_lt) | 匹配小于指定值的值       |
| [`$lte`](https://docs.mongodb.com/manual/reference/operator/query/lte/#op._S_lte) | 匹配小于等于指定值的值   |
| [`$in`](https://docs.mongodb.com/manual/reference/operator/query/in/#op._S_in) | 匹配数组中指定的任何值   |
| [`$nin`](https://docs.mongodb.com/manual/reference/operator/query/nin/#op._S_nin) | 不匹配数组中指定的任何值 |

### 2. 逻辑查询运算符

| Name                                                         | Description                                                  |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`$and`](https://docs.mongodb.com/manual/reference/operator/query/and/#op._S_and) | 将查询子句与逻辑连接起来,并返回符合这两个子句条件的所有文档  |
| [`$not`](https://docs.mongodb.com/manual/reference/operator/query/not/#op._S_not) | 反转查询表达式的效果，并返回与查询表达式不匹配的文档         |
| [`$nor`](https://docs.mongodb.com/manual/reference/operator/query/nor/#op._S_nor) | 用逻辑`NOR`连接查询子句，返回不能匹配这两个子句的所有文档    |
| [`$or`](https://docs.mongodb.com/manual/reference/operator/query/or/#op._S_or) | 将查询子句与逻辑或连接起来，返回与任一子句条件匹配的所有文档<br /> |

### 3. 对象查询运算符

| Name                                                         | Description                    |
| :----------------------------------------------------------- | :----------------------------- |
| [`$exists`](https://docs.mongodb.com/manual/reference/operator/query/exists/#op._S_exists) | 匹配具有指定字段的文档         |
| [`$type`](https://docs.mongodb.com/manual/reference/operator/query/type/#op._S_type) | 如果字段是指定类型,则选择文档. |

### 4. 评估查询操作符

| Name                                                         | Description                                    |
| :----------------------------------------------------------- | :--------------------------------------------- |
| [`$expr`](https://docs.mongodb.com/manual/reference/operator/query/expr/#op._S_expr) | 允许在查询语言中使用聚合表达式.                |
| [`$jsonSchema`](https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema) | V根据给定的JSON模式验证文档                    |
| [`$mod`](https://docs.mongodb.com/manual/reference/operator/query/mod/#op._S_mod) | 对字段的值执行模运算,并选择具有指定结果的文档. |
| [`$regex`](https://docs.mongodb.com/manual/reference/operator/query/regex/#op._S_regex) | 选择值与指定正则表达式匹配的文档               |
| [`$text`](https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text) | 执行文本搜索                                   |
| [`$where`](https://docs.mongodb.com/manual/reference/operator/query/where/#op._S_where) | 匹配满足JavaScript表达式的文档                 |

### 5. 地理空间查询运算符

### 6. 数组查询运算符

### 7. 位查询运算符

### 8. 投影查询运算符

### 9. 杂项查询操作符



## 二. 更新运算符

> [更新运算符](https://docs.mongodb.com/manual/reference/operator/update-field/)

### 1. $currentDate

**$currentDate运算符将字段的值设置为当前日期,可以是Date或timestamp. 默认类型为Date.**

`{ $currentDate: { <field1>: <typeSpecification1>, ... } }`

**<typeSpecification>** 取值以下: 

- 布尔值`true`将设置时间为**Date**
- 显示指定类型`{ $type: "timestamp" }`或 `{ $type: "date" }`,注意运算符区分大小写.只接受`"timestamp"` 或 `"date"`.

例: 

```shell
db.customers.insertOne(
   { _id: 1, status: "a", lastModified: ISODate("2013-10-02T01:11:18.965Z") }
)
db.customers.updateOne(
   { _id: 1 },
   {
     $currentDate: {
        lastModified: true,
        "cancellation.date": { $type: "timestamp" }
     },
     $set: {
        "cancellation.reason": "user request",
        status: "D"
     }
   }
)
db.customers.find().pretty()
{
   "_id" : 1,
   "status" : "D",
   "lastModified" : ISODate("2020-01-22T21:21:41.052Z"),
   "cancellation" : {
      "date" : Timestamp(1579728101, 1),
      "reason" : "user request"
   }
}
```

### 2. $INC

**$INC运算符将字段按指定值递增**

`{ $inc: { <field1>: <amount1>, <field2>: <amount2>, ... } }`

- `$INC`接受正数或负数的值
- 如果`<filed>`不存在将创建字段并将字段设置指定的值
- 将`$INC`使用在`null`值上将产生错误
- `$INC`是单个文档中的原子操作.

例:

```shell
  _id: 1,
  sku: "abc123",
  quantity: 10,
  metrics: {
    orders: 2,
    ratings: 3.5
  }
}
db.products.update(
   { sku: "abc123" },
   { $inc: { quantity: -2, "metrics.orders": 1 } }
)
{
   "_id" : 1,
   "sku" : "abc123",
   "quantity" : 8,
   "metrics" : {
      "orders" : 3,
      "ratings" : 3.5
   }
}
```

### 3. $min($max)

**$min($max)如果指定的值小于(大于)字段的当前值,则$min($max)将字段的值更新为指定的值.**

`{ $min: { <field1>: <value1>, ... } }`

- 如果`<filed>`不存在将创建字段并将字段设置指定的值
- 不同类型的值比较,参考 [BSON comparison order](https://docs.mongodb.com/manual/reference/bson-type-comparison-order/#faq-dev-compare-order-for-bson-types).
- `$min($max)`是单个文档中的原子操作.

### 4. $mul

**$mul将字段的值乘以一个数字.**

`{ $mul: { <field1>: <number1>, ... } }`

- 要更新的字段必须包含**数字值**.
- 如果该字段在文档中不存在,则`$mul`创建该字段,并将值设置为0,其数值类型与乘数相同.
- `$mul`是单个文档中的原子操作.
- 混合类型更新将提升相应的类型.

### 5. $rename

**$rename操作符更新字段的名称**

`{$rename: { <field1>: <newName1>, <field2>: <newName2>, ... } }`

- `$rename`执行逻辑是将**<oldName>**和**<newName>**都执行`$unset`后,再执行`$set`

- 如果文档中已有一个带有**<newName>**的字段,则`$rename`运算符将删除该字段,并将指定的**<field>**重命名为**<newName>**.
- 如果要重命名的字段在文档中不存在,则`$rename`不做任何操作.

### 6. $set

**$set操作符用指定的值替换字段的值**

`{ $set: { <field1>: <value1>, ... } }`

- 如果该字段不存在,则`$set`将添加具有指定值的新字段,前提是该新字段不违反类型约束. 
- 如果为不存在的字段指定了`.`的路径,则`$set`将根据需要创建嵌入的文档.

- 如果指定多个字段值对，$set将更新或创建每个字段.

### 7. $unset

**$unset操作符删除特定字段**

`{ $unset: { <field1>: "", ... } }`

- 如果字段不存在,则不做任何操作.
- 与`$`配合使用以匹配数组元素时,`$unset`会将匹配的元素替换为`null`,而不是从数组中删除匹配的元素. 此行为使数组大小和元素位置保持一致。

### 8. $setOnInsert

`db.collection.update(<query>,{ $setOnInsert: { <field1>: <value1>, ... } },{ upsert: true })`

- 如果`upsert:true`的更新操作导致插入文档,则`$setOnInsert`将指定的值赋给文档中的字段.
- 如果更新操作没有导致插入,则`$setOnInsert`不做任何操作.

## 三. 聚合阶段

## 四. 聚合运算符

## 五. 查询修改器







