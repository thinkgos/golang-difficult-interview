[TOC]

# 事务机制ACID

> 事务是数据库的一个重要功能。所谓的事务，就是指对数据进行读写的一系列操作。事务在执行时，会提供专门的属性保证，也就是 ACID 属性:
>
> - `原子性（Atomicity）`
> - ``一致性（Consistency）`
> - `隔离性（Isolation）`
> - `持久性（Durability）`

## 一. 事务 ACID 属性的要求

- 首先来看原子性。原子性的要求很明确，就是一个事务中的多个操作必须都完成，或者都不完成。业务应用使用事务时，原子性也是最被看重的一个属性.
- 第二个属性是一致性。这个很容易理解，就是指数据库中的数据在事务执行前后是一致的。
- 第三个属性是隔离性。它要求数据库在执行一个事务时，其它操作无法存取到正在执行事务访问的数据。
- 最后一个属性是持久性。数据库执行事务后，数据的修改要被持久化保存下来。当数据库重启后，数据的值需要是被修改后的值。

## 二. Redis 如何实现事务

事务的执行过程包含三个步骤，Redis 提供了 `MULTI`、`EXEC` 两个命令来完成这三个步骤:

- 第一步，客户端要使用一个命令显式地表示一个事务的开启. 在 Redis 中，这个命令就是 `MULTI`。
- 第二步，客户端把事务中本身要执行的具体操作（例如增删改数据）发送给服务器端.
- 第三步，客户端向服务器端发送提交事务的命令，让数据库实际执行第二步中发送的具体操作. Redis 提供的`EXEC`命令就是执行事务提交的
- 另外. 如果想主动放弃事务执行,使用Redis 提供了 `DISCARD` 命令

## 三. Redis 的事务机制能保证哪些属性？

### 1. 原子性

- 第一种情况是，在执行 EXEC 命令前，客户端发送的操作命令本身就有错误（比如语法错误，使用了不存在的命令），在命令入队时就被 Redis 实例判断出来了,我们也可以继续提交命令,等到执行了 EXEC 命令之后，Redis 就会拒绝执行所有提交的命令操作，返回事务失败的结果
- 事务操作入队时，命令和操作的数据类型不匹配，但 Redis 实例没有检查出错误。但是，在执行完 EXEC 命令以后，Redis 实际执行这些事务操作时，就会报错。`但不保证原子性???`

- 第三种情况：在执行事务的 EXEC 命令时，Redis 实例发生了故障，导致事务执行失败。

  > 在这种情况下，如果 Redis 开启了 AOF 日志，那么，只会有部分的事务操作被记录到 AOF 日志中。我们需要使用`redis-check-aof`工具检查 AOF 日志文件，这个工具可以把未完成的事务操作从 AOF 文件中去除。

### 2. 一致性

事务的一致性保证会受到错误命令、实例故障的影响。所以，我们按照命令出错和实例故障的发生时机，分成三种情况来看。

- 情况一：命令入队时就报错在这种情况下，事务本身就会被放弃执行，所以可以保证数据库的一致性。
- 情况二：命令入队时没报错，实际执行时报错在这种情况下，有错误的命令不会被执行，正确的命令可以正常执行，也不会改变数据库的一致性。
- 情况三：EXEC 命令执行时实例发生故障在这种情况下，实例故障后会进行重启，这就和数据恢复的方式有关了，我们要根据实例是否开启了 RDB 或 AOF 来分情况讨论下。
  - 如果我们没有开启 RDB 或 AOF，那么，实例故障重启后，数据都没有了，数据库是一致的。
  - 如果我们使用了 RDB 快照，因为 RDB 快照不会在事务执行时执行，所以，事务命令操作的结果不会被保存到 RDB 快照中，使用 RDB 快照进行恢复时，数据库里的数据也是一致的。
  - 如果我们使用了 AOF 日志，而事务操作还没有被记录到 AOF 日志时，实例就发生了故障，那么，使用 AOF 日志恢复的数据库数据是一致的。如果只有部分操作被记录到了 AOF 日志，我们可以使用 redis-check-aof 清除事务中已经完成的操作，数据库恢复后也是一致的。

### 3. 隔离性

事务的隔离性保证，会受到和事务一起执行的并发操作的影响。而事务执行又可以分成命令入队（EXEC 命令执行前）和命令实际执行（EXEC 命令执行后）两个阶段，所以，我们就针对这两个阶段，分成两种情况来分析：

- 并发操作在 EXEC 命令前执行，此时，隔离性的保证要使用 WATCH 机制来实现，否则隔离性无法保证；
- 并发操作在 EXEC 命令后执行，此时，隔离性可以保证

### 4. 持久性

持久性因为 Redis 是内存数据库，所以，数据是否持久化保存完全取决于 Redis 的持久化配置模式.

不管 Redis 采用什么持久化模式，事务的持久性属性是得不到保证的。

